name: ðŸ”’ Security & Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - 'package.json'
      - 'frontend/wipsie-app/package.json'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - dependencies
        - secrets
        - code
        - infrastructure

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ===============================================
  # ðŸ” DEPENDENCY VULNERABILITY SCAN
  # ===============================================
  dependency-scan:
    name: ðŸ” Scan Dependencies
    runs-on: ubuntu-latest
    if: contains(fromJson('["all", "dependencies"]'), github.event.inputs.scan_type) || github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ðŸ“¦ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ðŸ”’ Python Security Scan with Safety
      run: |
        echo "ðŸ”’ Running Python security scan..."
        pip install safety
        safety check --json --output safety-report.json || true
        safety check --short-report || true
    
    - name: ðŸ”’ Python Security Scan with Bandit
      run: |
        echo "ðŸ”’ Running Bandit security scan..."
        pip install bandit
        bandit -r backend/ -f json -o bandit-report.json || true
        bandit -r backend/ || true
    
    - name: ðŸ”’ Node.js Security Audit
      run: |
        cd frontend/wipsie-app
        echo "ðŸ”’ Running npm audit..."
        npm audit --audit-level=moderate --json > npm-audit.json || true
        npm audit --audit-level=moderate || true
    
    - name: ðŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json
          frontend/wipsie-app/npm-audit.json
        retention-days: 30

  # ===============================================
  # ðŸ•µï¸ SECRET SCANNING
  # ===============================================
  secret-scan:
    name: ðŸ•µï¸ Scan for Secrets
    runs-on: ubuntu-latest
    if: contains(fromJson('["all", "secrets"]'), github.event.inputs.scan_type) || github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ•µï¸ Run TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
    
    - name: ðŸ” Custom Secret Pattern Check
      run: |
        echo "ðŸ” Checking for common secret patterns..."
        
        # Check for common secret patterns
        echo "Checking for AWS keys..."
        grep -r "AKIA[0-9A-Z]{16}" . --exclude-dir=.git || echo "No AWS access keys found"
        
        echo "Checking for private keys..."
        grep -r "BEGIN.*PRIVATE.*KEY" . --exclude-dir=.git || echo "No private keys found"
        
        echo "Checking for API keys..."
        grep -r "api[_-]key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" . --exclude-dir=.git || echo "No API keys found"
        
        echo "âœ… Secret scan completed"

  # ===============================================
  # ðŸ”¬ CODE QUALITY SCAN
  # ===============================================
  code-scan:
    name: ðŸ”¬ Code Quality Scan
    runs-on: ubuntu-latest
    if: contains(fromJson('["all", "code"]'), github.event.inputs.scan_type) || github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”¬ SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
    - name: ðŸ Python Code Quality
      run: |
        pip install flake8 pylint mypy
        
        echo "ðŸ” Running Flake8..."
        flake8 backend/ --max-line-length=88 --extend-ignore=E203,W503 || true
        
        echo "ðŸ” Running Pylint..."
        pylint backend/ || true
        
        echo "ðŸ” Running MyPy..."
        mypy backend/ --ignore-missing-imports || true
    
    - name: ðŸŽ¨ Frontend Code Quality
      run: |
        cd frontend/wipsie-app
        npm ci
        
        echo "ðŸ” Running ESLint..."
        npm run lint || true
        
        echo "ðŸ” TypeScript Check..."
        npx tsc --noEmit || true

  # ===============================================
  # ðŸ—ï¸ INFRASTRUCTURE SECURITY SCAN
  # ===============================================
  infrastructure-scan:
    name: ðŸ—ï¸ Infrastructure Security
    runs-on: ubuntu-latest
    if: contains(fromJson('["all", "infrastructure"]'), github.event.inputs.scan_type) || github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ³ Docker Security Scan
      run: |
        echo "ðŸ³ Scanning Docker configurations..."
        
        # Install hadolint for Dockerfile linting
        wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
        chmod +x hadolint
        
        # Scan Dockerfiles
        find . -name "Dockerfile*" -exec echo "Scanning {}" \; -exec ./hadolint {} \; || true
    
    - name: â˜ï¸ CloudFormation Security Scan
      run: |
        echo "â˜ï¸ Scanning CloudFormation templates..."
        pip install cfn-lint
        
        # Scan CloudFormation templates
        find . -name "*.yml" -o -name "*.yaml" | grep -E "(cloudformation|template)" | xargs cfn-lint || true
    
    - name: ðŸ”§ Terraform Security Scan (if applicable)
      run: |
        echo "ðŸ”§ Checking for Terraform files..."
        if find . -name "*.tf" | grep -q .; then
          echo "Terraform files found, install tfsec..."
          wget -O tfsec https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64
          chmod +x tfsec
          ./tfsec . || true
        else
          echo "No Terraform files found"
        fi

  # ===============================================
  # ðŸ“¤ DEPENDENCY UPDATES
  # ===============================================
  update-dependencies:
    name: ðŸ“¤ Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.scan_type == 'all'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ðŸ“¦ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ðŸ”„ Update Python Dependencies
      run: |
        echo "ðŸ”„ Checking for Python dependency updates..."
        pip install pip-tools
        
        # Generate updated requirements
        pip-compile --upgrade requirements.in || echo "No requirements.in found"
        
        # Check for outdated packages
        pip list --outdated > python-outdated.txt || true
        
        echo "ðŸ“Š Outdated Python packages:"
        cat python-outdated.txt || echo "No outdated packages"
    
    - name: ðŸ”„ Update Node.js Dependencies
      run: |
        cd frontend/wipsie-app
        echo "ðŸ”„ Checking for Node.js dependency updates..."
        
        # Check for outdated packages
        npm outdated > node-outdated.txt || true
        
        echo "ðŸ“Š Outdated Node.js packages:"
        cat node-outdated.txt || echo "No outdated packages"
        
        # Update dependencies (minor and patch versions only)
        npm update
    
    - name: ðŸ“‹ Create Dependency Update Report
      run: |
        echo "ðŸ“‹ Creating dependency update report..."
        
        cat > dependency-report.md << EOF
        # Dependency Update Report
        
        ## Python Dependencies
        \`\`\`
        $(cat python-outdated.txt || echo "No outdated Python packages")
        \`\`\`
        
        ## Node.js Dependencies
        \`\`\`
        $(cat frontend/wipsie-app/node-outdated.txt || echo "No outdated Node.js packages")
        \`\`\`
        
        Generated on: $(date)
        EOF
    
    - name: ðŸ“¤ Upload Dependency Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependency-report.md
        retention-days: 30

  # ===============================================
  # ðŸ“¢ SECURITY REPORT
  # ===============================================
  security-report:
    name: ðŸ“¢ Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan, code-scan, infrastructure-scan]
    if: always()
    
    steps:
    - name: ðŸ“¥ Download Security Reports
      uses: actions/download-artifact@v4
      with:
        name: security-reports
        path: reports/
      continue-on-error: true
    
    - name: ðŸ“Š Generate Comprehensive Security Report
      run: |
        echo "ðŸ“Š Generating comprehensive security report..."
        
        cat > security-summary.md << EOF
        # ðŸ”’ Security Scan Summary
        
        ## Scan Results
        - **Dependency Scan**: ${{ needs.dependency-scan.result }}
        - **Secret Scan**: ${{ needs.secret-scan.result }}
        - **Code Quality Scan**: ${{ needs.code-scan.result }}
        - **Infrastructure Scan**: ${{ needs.infrastructure-scan.result }}
        
        ## Generated Reports
        $(find reports/ -name "*.json" 2>/dev/null | while read file; do echo "- $file"; done || echo "No detailed reports available")
        
        ## Recommendations
        1. Review all security scan results
        2. Update vulnerable dependencies
        3. Fix any secret leaks immediately
        4. Address code quality issues
        5. Secure infrastructure configurations
        
        Generated on: $(date)
        Commit: ${{ github.sha }}
        EOF
        
        cat security-summary.md
    
    - name: ðŸ“¤ Upload Security Summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md
        retention-days: 90
    
    - name: ðŸ“¢ Notify Security Team
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#security",
            "username": "Security Bot",
            "icon_emoji": ":shield:",
            "attachments": [{
              "color": "${{ needs.dependency-scan.result == 'success' && needs.secret-scan.result == 'success' && needs.code-scan.result == 'success' && needs.infrastructure-scan.result == 'success' && 'good' || 'warning' }}",
              "title": "ðŸ”’ Security Scan Complete",
              "text": "Security scan completed for Wipsie application",
              "fields": [
                {
                  "title": "Dependency Scan",
                  "value": "${{ needs.dependency-scan.result }}",
                  "short": true
                },
                {
                  "title": "Secret Scan",
                  "value": "${{ needs.secret-scan.result }}",
                  "short": true
                },
                {
                  "title": "Code Quality",
                  "value": "${{ needs.code-scan.result }}",
                  "short": true
                },
                {
                  "title": "Infrastructure",
                  "value": "${{ needs.infrastructure-scan.result }}",
                  "short": true
                }
              ]
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
