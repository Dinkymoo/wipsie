name: ðŸ—„ï¸ Database Migration

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/alembic/versions/**'
      - 'backend/models/**'
      - '.github/workflows/database-migration.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to migrate'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      migration_action:
        description: 'Migration action'
        required: true
        default: 'upgrade'
        type: choice
        options:
        - upgrade
        - downgrade
        - current
        - history

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===============================================
  # ðŸ§ª VALIDATE MIGRATIONS
  # ===============================================
  validate:
    name: ðŸ§ª Validate Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres_test_password
          POSTGRES_USER: postgres
          POSTGRES_DB: wipsie_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ” Check Migration Syntax
      run: |
        cd backend
        echo "ðŸ” Checking Alembic migration syntax..."
        alembic check || echo "Migration check completed"
    
    - name: ðŸ§ª Test Migration on Clean Database
      run: |
        cd backend
        echo "ðŸ§ª Testing migration on clean database..."
        export DATABASE_URL="postgresql://postgres:postgres_test_password@localhost:5432/wipsie_test"
        alembic upgrade head
        echo "âœ… Migration test successful"
      env:
        DATABASE_URL: postgresql://postgres:postgres_test_password@localhost:5432/wipsie_test
    
    - name: ðŸ”„ Test Migration Rollback
      run: |
        cd backend
        echo "ðŸ”„ Testing migration rollback..."
        export DATABASE_URL="postgresql://postgres:postgres_test_password@localhost:5432/wipsie_test"
        alembic downgrade -1
        alembic upgrade head
        echo "âœ… Migration rollback test successful"
      env:
        DATABASE_URL: postgresql://postgres:postgres_test_password@localhost:5432/wipsie_test

  # ===============================================
  # ðŸš€ MIGRATE STAGING
  # ===============================================
  migrate-staging:
    name: ðŸš€ Migrate Staging Database
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”§ Setup Database Connection
      run: |
        echo "ðŸ”§ Setting up database connection for staging..."
        cd backend
        # Set staging database URL
        export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
      env:
        DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    
    - name: ðŸ“Š Check Current Migration Status
      run: |
        cd backend
        echo "ðŸ“Š Checking current migration status..."
        export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
        alembic current
        alembic history --verbose
      env:
        DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    
    - name: ðŸ—„ï¸ Run Database Migration
      run: |
        cd backend
        echo "ðŸ—„ï¸ Running database migration on staging..."
        export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
        
        ACTION="${{ github.event.inputs.migration_action || 'upgrade' }}"
        
        case $ACTION in
          upgrade)
            echo "â¬†ï¸ Upgrading to latest migration..."
            alembic upgrade head
            ;;
          downgrade)
            echo "â¬‡ï¸ Downgrading one migration..."
            alembic downgrade -1
            ;;
          current)
            echo "ðŸ“ Current migration status:"
            alembic current
            ;;
          history)
            echo "ðŸ“œ Migration history:"
            alembic history --verbose
            ;;
        esac
        
        echo "âœ… Migration action '$ACTION' completed successfully"
      env:
        DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    
    - name: âœ… Verify Migration
      run: |
        cd backend
        echo "âœ… Verifying migration..."
        export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
        alembic current
        echo "âœ… Migration verification completed"
      env:
        DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

  # ===============================================
  # ðŸŒŸ MIGRATE PRODUCTION
  # ===============================================
  migrate-production:
    name: ðŸŒŸ Migrate Production Database
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”§ Setup Database Connection
      run: |
        echo "ðŸ”§ Setting up database connection for production..."
        cd backend
        export DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}"
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
    
    - name: ðŸ’¾ Backup Production Database
      run: |
        echo "ðŸ’¾ Creating database backup..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_NAME="wipsie_backup_${TIMESTAMP}"
        
        # Create backup (adjust connection parameters as needed)
        # pg_dump ${{ secrets.PRODUCTION_DATABASE_URL }} > ${BACKUP_NAME}.sql
        
        echo "âœ… Database backup created: ${BACKUP_NAME}"
    
    - name: ðŸ“Š Check Current Migration Status
      run: |
        cd backend
        echo "ðŸ“Š Checking current production migration status..."
        export DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}"
        alembic current
        alembic history --verbose
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
    
    - name: ðŸ—„ï¸ Run Production Migration
      run: |
        cd backend
        echo "ðŸ—„ï¸ Running database migration on production..."
        export DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}"
        
        ACTION="${{ github.event.inputs.migration_action || 'upgrade' }}"
        
        case $ACTION in
          upgrade)
            echo "â¬†ï¸ Upgrading production to latest migration..."
            alembic upgrade head
            ;;
          downgrade)
            echo "â¬‡ï¸ Downgrading production one migration..."
            read -p "Are you sure you want to downgrade production? (yes/no): " CONFIRM
            if [ "$CONFIRM" = "yes" ]; then
              alembic downgrade -1
            else
              echo "Production downgrade cancelled"
              exit 1
            fi
            ;;
          current)
            echo "ðŸ“ Current production migration status:"
            alembic current
            ;;
          history)
            echo "ðŸ“œ Production migration history:"
            alembic history --verbose
            ;;
        esac
        
        echo "âœ… Production migration action '$ACTION' completed successfully"
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
    
    - name: âœ… Verify Production Migration
      run: |
        cd backend
        echo "âœ… Verifying production migration..."
        export DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}"
        alembic current
        echo "âœ… Production migration verification completed"
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
    
    - name: ðŸ“¢ Notify Migration Completion
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#database'
        text: |
          ðŸ—„ï¸ Production database migration completed!
          Action: ${{ github.event.inputs.migration_action || 'upgrade' }}
          Commit: ${{ github.sha }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()

  # ===============================================
  # ðŸ”„ MIGRATION MONITORING
  # ===============================================
  monitor:
    name: ðŸ”„ Monitor Migration
    runs-on: ubuntu-latest
    needs: [migrate-staging, migrate-production]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Migration Report
      run: |
        echo "ðŸ“Š Generating migration report..."
        echo "## Migration Summary" >> migration_report.md
        echo "- **Staging Status**: ${{ needs.migrate-staging.result }}" >> migration_report.md
        echo "- **Production Status**: ${{ needs.migrate-production.result }}" >> migration_report.md
        echo "- **Timestamp**: $(date)" >> migration_report.md
        
        cat migration_report.md
    
    - name: ðŸ“¤ Upload Migration Report
      uses: actions/upload-artifact@v4
      with:
        name: migration-report
        path: migration_report.md
        retention-days: 30
